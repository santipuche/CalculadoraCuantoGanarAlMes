<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Presupuesto</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/recharts/umd/Recharts.js"></script>
    <script src="https://unpkg.com/lucide-react"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        const { 
            PlusCircle, Trash2, DollarSign, 
            PieChart: ChartIcon, Moon, Sun, RotateCcw 
        } = lucide;
        const { 
            PieChart, Pie, Cell, ResponsiveContainer, Legend, Tooltip 
        } = Recharts;

        // --- POLYFILL PARA STORAGE ---
        // Esto permite que el c√≥digo que ten√≠as funcione usando el localStorage del navegador
        window.storage = {
            get: async (key) => ({ value: localStorage.getItem(key) }),
            set: async (key, val) => { localStorage.setItem(key, val); },
            delete: async (key) => { localStorage.removeItem(key); }
        };

        function PresupuestoMensual() {
            // Pegamos aqu√≠ tu l√≥gica adaptada
            const [transacciones, setTransacciones] = useState([]);
            const [modoOscuro, setModoOscuro] = useState(false);
            const [mostrarConfirmacion, setMostrarConfirmacion] = useState(false);
            const [cargando, setCargando] = useState(true);

            useEffect(() => {
                const cargarDatos = async () => {
                    try {
                        const resultadoTransacciones = await window.storage.get('transacciones');
                        if (resultadoTransacciones && resultadoTransacciones.value) {
                            setTransacciones(JSON.parse(resultadoTransacciones.value));
                        }
                        const resultadoModo = await window.storage.get('modoOscuro');
                        if (resultadoModo && resultadoModo.value) {
                            setModoOscuro(JSON.parse(resultadoModo.value));
                        }
                    } catch (error) {
                        console.log('Error al cargar:', error);
                    } finally {
                        setCargando(false);
                    }
                };
                cargarDatos();
            }, []);

            useEffect(() => {
                if (!cargando) {
                    window.storage.set('transacciones', JSON.stringify(transacciones));
                }
            }, [transacciones, cargando]);

            useEffect(() => {
                if (!cargando) {
                    window.storage.set('modoOscuro', JSON.stringify(modoOscuro));
                }
            }, [modoOscuro, cargando]);

            // --- CATEGOR√çAS Y L√ìGICA (Tu c√≥digo original) ---
            const categoriasGastos = { casa: 'Casa', entretenimiento: 'Entretenimiento', transporte: 'Transporte', tarjetas: 'Tarjetas y Pr√©stamos', alimento: 'Alimento', impuestos: 'Impuestos', cuidadoPersonal: 'Cuidado Personal', varios: 'Varios', seguros: 'Seguros', ahorros: 'Ahorros', personalizada: '+ Agregar categor√≠a personalizada' };
            const categoriasIngresos = { salario: 'Salario', freelance: 'Freelance', inversiones: 'Inversiones', alquiler: 'Alquiler', negocio: 'Negocio', bonos: 'Bonos', otros: 'Otros', personalizada: '+ Agregar categor√≠a personalizada' };
            const categoriasDeudas = { prestamo: 'Pr√©stamo Personal', hipoteca: 'Hipoteca', tarjetaCredito: 'Tarjeta de Cr√©dito', prestamoCoche: 'Pr√©stamo de Coche', estudiante: 'Pr√©stamo Estudiantil', familiar: 'Deuda Familiar', otros: 'Otros', personalizada: '+ Agregar categor√≠a personalizada' };

            const agregarTransaccion = () => {
                const hoy = new Date().toISOString().split('T')[0];
                setTransacciones([...transacciones, { tipo: 'gasto', categoria: 'casa', concepto: '', monto: 0, interes: 0, fecha: hoy }]);
            };

            const eliminarTransaccion = (index) => {
                setTransacciones(transacciones.filter((_, i) => i !== index));
            };

            const reiniciar = async () => {
                setTransacciones([]);
                setMostrarConfirmacion(false);
                await window.storage.delete('transacciones');
            };

            const actualizarTransaccion = (index, campo, valor) => {
                const nuevas = [...transacciones];
                if (campo === 'monto') nuevas[index][campo] = parseFloat(valor) || 0;
                else if (campo === 'interes') nuevas[index][campo] = parseFloat(valor) || 0;
                else if (campo === 'tipo') {
                    nuevas[index][campo] = valor;
                    nuevas[index].interes = 0;
                    nuevas[index].categoria = valor === 'gasto' ? 'casa' : valor === 'ingreso' ? 'salario' : 'prestamo';
                } else if (campo === 'categoria' && valor === 'personalizada') {
                    nuevas[index].categoriaPersonalizada = true;
                    nuevas[index][campo] = '';
                } else if (campo === 'categoriaTexto') nuevas[index].categoria = valor;
                else nuevas[index][campo] = valor;
                setTransacciones(nuevas);
            };

            const calcularTotalDeuda = (monto, interes) => monto + (monto * (interes || 0) / 100);

            // Totales
            const totalIngresos = transacciones.filter(t => t.tipo === 'ingreso').reduce((sum, t) => sum + t.monto, 0);
            const totalGastos = transacciones.filter(t => t.tipo === 'gasto').reduce((sum, t) => sum + t.monto, 0);
            const totalDeudas = transacciones.filter(t => t.tipo === 'deuda').reduce((sum, t) => sum + calcularTotalDeuda(t.monto, t.interes), 0);
            const diferencia = totalIngresos - totalGastos - totalDeudas;

            // Colores y Datos para Gr√°ficos (Simplificado para el ejemplo)
            const COLORES = ['#0088FE', '#00C49F', '#FFBB28', '#FF8042', '#8884d8'];

            const prepararDatosGrafico = (tipo, categorias) => {
                const base = Object.entries(categorias)
                    .filter(([key]) => key !== 'personalizada')
                    .map(([key, nombre]) => ({
                        name: nombre,
                        value: transacciones
                            .filter(t => t.tipo === tipo && t.categoria === key)
                            .reduce((sum, t) => sum + (tipo === 'deuda' ? calcularTotalDeuda(t.monto, t.interes) : t.monto), 0)
                    }))
                    .filter(i => i.value > 0);
                
                const pers = transacciones
                    .filter(t => t.tipo === tipo && t.categoriaPersonalizada)
                    .map(t => ({ name: t.categoria, value: tipo === 'deuda' ? calcularTotalDeuda(t.monto, t.interes) : t.monto }));
                
                return [...base, ...pers];
            };

            const datosIngresos = prepararDatosGrafico('ingreso', categoriasIngresos);
            const datosGastos = prepararDatosGrafico('gasto', categoriasGastos);
            const datosDeudas = prepararDatosGrafico('deuda', categoriasDeudas);

            // Clases din√°micas
            const bgPrimary = modoOscuro ? 'bg-slate-900' : 'bg-slate-50';
            const bgSecondary = modoOscuro ? 'bg-slate-800' : 'bg-white';
            const textPrimary = modoOscuro ? 'text-slate-100' : 'text-slate-800';
            const textSecondary = modoOscuro ? 'text-slate-300' : 'text-slate-600';
            const borderColor = modoOscuro ? 'border-slate-700' : 'border-slate-200';
            const inputBg = modoOscuro ? 'bg-slate-700 border-slate-600 text-slate-100' : 'bg-white border-slate-300';

            if (cargando) return <div className={`min-h-screen ${bgPrimary} flex items-center justify-center text-blue-600`}>Cargando...</div>;

            return (
                <div className={`min-h-screen ${bgPrimary} p-4 transition-colors font-sans`}>
                    <div className="max-w-7xl mx-auto">
                        <div className="flex justify-between items-center mb-6">
                            <h1 className={`text-2xl font-bold ${textPrimary}`}>Mi Presupuesto</h1>
                            <div className="flex gap-2">
                                <button onClick={() => setMostrarConfirmacion(true)} className="p-2 bg-red-600 text-white rounded-lg"><RotateCcw size={20}/></button>
                                <button onClick={() => setModoOscuro(!modoOscuro)} className="p-2 bg-blue-600 text-white rounded-lg">{modoOscuro ? '‚òÄÔ∏è' : 'üåô'}</button>
                            </div>
                        </div>

                        {/* --- RESUMEN --- */}
                        <div className={`${bgSecondary} p-6 rounded-2xl shadow mb-6 grid grid-cols-2 md:grid-cols-4 gap-4`}>
                            <div className="p-4 bg-green-100 rounded-xl"><p className="text-green-700 text-sm">Ingresos</p><p className="text-xl font-bold">${totalIngresos.toFixed(2)}</p></div>
                            <div className="p-4 bg-red-100 rounded-xl"><p className="text-red-700 text-sm">Gastos</p><p className="text-xl font-bold">${totalGastos.toFixed(2)}</p></div>
                            <div className="p-4 bg-yellow-100 rounded-xl"><p className="text-yellow-700 text-sm">Deudas</p><p className="text-xl font-bold">${totalDeudas.toFixed(2)}</p></div>
                            <div className={`p-4 rounded-xl ${diferencia >= 0 ? 'bg-blue-100' : 'bg-orange-100'}`}><p className="text-sm">Balance</p><p className="text-xl font-bold">${diferencia.toFixed(2)}</p></div>
                        </div>

                        {/* --- LISTA DE TRANSACCIONES --- */}
                        <div className={`${bgSecondary} p-6 rounded-2xl shadow mb-6`}>
                            <div className="flex justify-between mb-4">
                                <h2 className={`text-xl font-bold ${textPrimary}`}>Transacciones</h2>
                                <button onClick={agregarTransaccion} className="bg-blue-600 text-white px-4 py-2 rounded-lg flex items-center gap-2"><PlusCircle size={18}/> Agregar</button>
                            </div>
                            <div className="space-y-3 max-h-96 overflow-y-auto">
                                {transacciones.map((t, i) => (
                                    <div key={i} className={`p-3 border ${borderColor} rounded-lg flex flex-wrap gap-2 items-center`}>
                                        <input type="date" value={t.fecha} onChange={e => actualizarTransaccion(i, 'fecha', e.target.value)} className={`p-1 text-sm rounded ${inputBg}`} />
                                        <select value={t.tipo} onChange={e => actualizarTransaccion(i, 'tipo', e.target.value)} className={`p-1 text-sm rounded ${inputBg}`}>
                                            <option value="gasto">Gasto</option>
                                            <option value="ingreso">Ingreso</option>
                                            <option value="deuda">Deuda</option>
                                        </select>
                                        <input type="text" placeholder="Concepto" value={t.concepto} onChange={e => actualizarTransaccion(i, 'concepto', e.target.value)} className={`flex-1 p-1 text-sm rounded ${inputBg}`} />
                                        <input type="number" placeholder="Monto" value={t.monto} onChange={e => actualizarTransaccion(i, 'monto', e.target.value)} className={`w-24 p-1 text-sm rounded ${inputBg}`} />
                                        <button onClick={() => eliminarTransaccion(i)} className="text-red-500"><Trash2 size={18}/></button>
                                    </div>
                                ))}
                            </div>
                        </div>

                        {/* --- GR√ÅFICOS --- */}
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                            {[ 
                                { titulo: "Ingresos", datos: datosIngresos, color: "#10b981" },
                                { titulo: "Gastos", datos: datosGastos, color: "#ef4444" },
                                { titulo: "Deudas", datos: datosDeudas, color: "#f59e0b" }
                            ].map((g, idx) => (
                                <div key={idx} className={`${bgSecondary} p-4 rounded-2xl shadow h-64`}>
                                    <h3 className={`text-center font-bold mb-2 ${textPrimary}`}>{g.titulo}</h3>
                                    {g.datos.length > 0 ? (
                                        <ResponsiveContainer width="100%" height="80%">
                                            <PieChart>
                                                <Pie data={g.datos} innerRadius={40} outerRadius={60} dataKey="value">
                                                    {g.datos.map((_, index) => <Cell key={index} fill={COLORES[index % COLORES.length]} />)}
                                                </Pie>
                                                <Tooltip />
                                            </PieChart>
                                        </ResponsiveContainer>
                                    ) : <p className="text-center text-gray-400 text-sm mt-10">Sin datos</p>}
                                </div>
                            ))}
                        </div>
                    </div>
                    
                    {/* Modal Confirmar */}
                    {mostrarConfirmacion && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4">
                            <div className={`${bgSecondary} p-6 rounded-xl max-w-sm w-full`}>
                                <p className={textPrimary}>¬øBorrar todos los datos?</p>
                                <div className="flex justify-end gap-2 mt-4">
                                    <button onClick={() => setMostrarConfirmacion(false)} className="px-4 py-2 text-gray-500">No</button>
                                    <button onClick={reiniciar} className="px-4 py-2 bg-red-600 text-white rounded">S√≠, borrar</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<PresupuestoMensual />);
    </script>
</body>
</html>
